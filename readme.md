# 基于 FPGA 的声音处理系统

本项目用于是一个可实现音频去噪、实时人声调整、回声消除、多重声音分离和声纹识别功能，并综合利用了显示屏、网口和串口等接口的 FPGA 音频数据处理输入输出系统，采用实时流处理。

## 仓库结构

```
|-- dataset                 // 深度学习数据集
|-- Document                // 相关技术文档和说明
|-- FPGA                    // 比特流文件、约束文件和 ROM 初始化文件
|-- model                   // 深度学习模型文件
|-- Python                  // python 代码
|-- RTL                     // RTL 代码
|-- Sample                  // 测试音频
|-- Software                // Matlab 仿真代码和相关系统控制程序
```

## 系统参数规格和功能指标

| 项目 | 参数 |
| :--: | :---: |
| 输入采样频率 | 48kHz |
| 输出采样频率 | 48kHz |
| 输入采样位深（量化位宽） | 16bit |
| 输出采样位深（量化位宽） | 16bit |
| 输入通道数 | 2-left, right |
| 输出通道数 | 1-left |
| 以太网传输等效位深 | 16bit |

受支持的功能：

  * 人声实时调整；
  * 抑制音频回音效果；
  * 音频中背景声抑制；
  * 分离背景声和人声；
  * 音频的流式传输（UDP）；
  * 串口功能控制；
  * 音频分类、声纹识别、人声情绪和性别识别（调用[深度学习模型](#深度学习模型)）

## FPGA 资源利用


## 系统架构

系统通过 ES7243E ADC 模块将音频信号通过 3.5mm 耳机接口采样到开发板，在默认情况下，FPGA 本地处理音频的功能均被禁用，此时从 ADC 模块采样的数字信号的音频流直接通过 ES8156 DAC 模块输出模拟音频信号。

系统通过 UART 串口发送的命令来实现相关功能的启用和禁用，而通过以太网发送数据的功能始终启用，其数据源来自从 ADC 模块采样的原始数字信号，除非启用人声变声功能，此时以太网模块的输入数据来自人声变声模块输出的数据。

此外，经过处理的数据按照帧编组，与 FFT 处理信息一并输入 HDMI 显示模块以显示该帧的处理前后频谱幅值，同时接收声纹分类信息。系统拓扑图如下图所示。

<div align='center'><img src='./Document\pic\绘图3.png' width='600px' title='系统拓扑图'></div>

## 模块架构

你可以[点此](./Document/voice_adjusted_theory.md)了解每个模块处理的实现原理。

### 回声消除模块

<div align='center'><img src='./Document\pic\绘图4.png' width='450px' title='回声消除模块结构图'></div>

### 人声变声模块

<div align='center'><img src='./Document\pic\绘图5.png' width='430px' title='人声变声模块结构图'></div>

### 背景噪声消除和多重声音分离模块

系统将给定音频在时域上分成多个处理段，在给定音频数据输入模块时，在每段音频处理段分别应用对应的频率抑制和提取配置，从而在整个音频上都有较为精确的去噪和声音提取效果。

在设计时，去噪功能与声音分离功能只需固化不同 ROM 的配置文件，例化成两个模块即可。去噪模块分为 46 个处理段，多重声音分离模块分为 45 个处理段，每段满足 21 个 1024 FFT 处理帧。

<div align='center'><img src='./Document\pic\绘图8.png' width='550px' title='人声变声模块结构图'></div>

### UART 模块

UART 模块用于接收由计算机发送的控制命令，以指示当前启用的功能，同时用于将声纹识别结果发送到计算机。你可以[点此](./Document\control_command.md)查看 UART 控制命令。

### 以太网数据发送模块

以太网数据发送模块用于将音频数据发送到计算机，以便执行深度学习推理任务。为避免传输出错和计算机 python 程序错误编码，系统使用段同步信号 `voice_vsync` 和帧有效信号 `voice_href` 来指示以太网模块发送数据，每段数据有 128 帧，每帧的宽度为 512 个时钟周期（即 512 个音频数据）；在每段数据的开头和结尾，系统加入了起始标识符：`FF B3`，终止标识符：`FF B4`。

## 深度学习模型

系统通过作者存储库中的[音频分类]()项目实现了音频分类、声纹识别、人声情绪和性别识别功能。为本项目预构建的模型文件位于 `./model` 文件夹内。你可以访问该仓库自行训练模型。