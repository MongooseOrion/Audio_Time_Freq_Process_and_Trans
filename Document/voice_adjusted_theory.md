<!-- =====================================================================
* Copyright (c) 2023, MongooseOrion.
* All rights reserved.
*
* The following code snippet may contain portions that are derived from
* OPEN-SOURCE communities, and these portions will be licensed with: 
*
* <NULL>
*
* If there is no OPEN-SOURCE licenses are listed, it indicates none of
* content in this Code document is sourced from OPEN-SOURCE communities. 
*
* In this case, the document is protected by copyright, and any use of
* all or part of its content by individuals, organizations, or companies
* without authorization is prohibited, unless the project repository
* associated with this document has added relevant OPEN-SOURCE licenses
* by github.com/MongooseOrion. 
*
* Please make sure using the content of this document in accordance with 
* the respective OPEN-SOURCE licenses. 
* 
* THIS CODE IS PROVIDED BY https://github.com/MongooseOrion. 
* FILE ENCODER TYPE: GBK
* ========================================================================
-->
# 回声消除、去噪和音色调整的原理

## 回声消除原理

由于声波在传播过程中遇到了墙壁或其他障碍物而反射，会导致回声影响。当录制音频时，这种反射会被同时记录下来，导致原始声音与回声的重叠。通过引入一定程度的信号延迟，并通过信号加权相减的方式可以消除延迟引起的回声。

具体而言，可以采用一种简单的线性加权相减方式，信号输出函数如下述公式所示：

$$y(n)=x(n) - \alpha x(n-N)$$

其中， $x(n)$ 表示序列索引为 $n$ 的量化数据， $\alpha$ 表示权重系数， $N$ 表示延迟样本数（窗口样本）。

上述公式通过引入延迟并进行加权相减的处理，尽量减少了原始信号与延迟信号之间的重叠，从而减少了回声的影响。

## 音色调整原理

在进行人声调整时，人声的基音频率是一个重要的参数。在频域分析中，基音频率和其谐波通常会在频谱图中呈现为峰值。这些峰值对应于声音信号中不同频率成分的能量。基音频率对应于声谱图中的第一个主要峰值，而其他谐波对应于较高的峰值，其频率是基音频率的整数倍。

男性的声音通常具有较低的基音频率，而女性的声音则具有较高的基音频率。通过增加声音的基音频率，可以使男性声音听起来更像女性声音；通过减小声音的基音频率，可以使女性声音听起来更像男性声音。这通常是通过改变基音周期来实现，可分别在时域和频域进行处理。

如果选择在时域处理，可对输入序列强制重采样。例如给定带有特征输入序列样本数为 1024，按照某种抽样方法抽取样本数为 768，采样率维持原样，则可以提升特征频率。由于样本数变少，为了保持采样率不变，需要应用某种算法复制重采样后的序列部分或全部样本，那么在相同的时间宽度内原序列和采样后的序列将拥有相同的样本数量，如下图所示。一般而言，由于采样的不确定性和噪声，抽样后相近的样本之间幅值可能存在剧烈变化，这样会使音频不够自然和平滑。为解决该问题，可选取当前抽样样本与其前几个样本的均值作为新的采样样本，这样可抑制样本幅值变化剧烈导致的齿音等不良影响，获得变化平滑的序列。

<div align = 'center'><img src='./pic\00000.png' width = '450px' alt = '' title = '时域改变基音频率原理示意'></div>

如果在频域处理，则可以利用在频域上进行频谱搬移来实现变声。频谱搬移是将频谱图在频率轴上向高频或低频方向移动一定的距离。移动频谱的距离通常由变声的目标决定。这个移动可以通过在频域上对快速傅里叶变换（FFT）结果进行平移操作来实现。如果将频谱向高频方向移动，则基音频率将增加，声音听起来会更高音调。反之，如果将频谱向低频方向移动，则基音频率将减小，声音听起来会更低音调。

时域上的抽样方法简单直观，计算速度快，但可能会导致声音质量损失；而频域上的频谱搬移方法保留了频谱信息，变声效果较好，但计算复杂度较高，实现难度较大。


## 去除背景声和多重声音分离原理

*本文档仅讨论对某一给定音频的 FPGA 处理方法，而不涉及自适应降噪方法。*

去噪和声音分离的基本原理是抑制频域中的某些频率成分的幅值，和（或）提升某些频率成分的幅值。然而在 FPGA 流式处理的过程中，如果 FFT 窗口宽度与滑动步长相同，也即每次处理的批数据两两均无重叠，则输出的声音可能会有咔哒声，这是因为每次处理的数据流都是孤立的，那么在频域进行处理后反傅里叶变换时前一段序列与后一段序列间不是平滑变化的，而是呈现出峰值。为了使得流式处理时音频是平滑、连续的，滑动处理的步长应当小于 FFT 窗口宽度，例如 $\frac{1}{2}$ ，如下图所示。特别的，在 FPGA 处理时，如果将滑动处理的步长设置为 FFT 窗口宽度一半，则可以以较小的算法复杂度重建出原始信号。

<div align = 'center'><img src='../Document\pic\绘图1.png' height = '270' title = '时域音频信号加窗和滑窗方式示意'></div>

为简化在 FPGA 上处理重叠 FFT 的部分，可以在傅里叶正变换（FFT）前和傅里叶逆变换（iFFT）之后分别应用正弦窗函数。这是因为正弦窗乘以正弦窗等于应用汉宁窗（对同一信号应用两次正弦窗），而应用汉宁窗的两组数据若恰好有一半的样本重叠，则重叠的部分相加恒等于 1，所以对于前后两次滑动处理的数据（它们滑动处理的步长必须为 FFT 窗口宽度的一半），如果在 FFT 之前和 iFFT 之后分别应用正弦窗，然后再对两组数据 iFFT 变换后重叠的序列的幅值相加，即可重建出原始信号。

<><><>

利用该原理，应用于在频谱上进行去噪和多重声音处理的前后，那么恢复的时域信号将能呈现出更好的清晰度和保真度。

对于给定任一音频，去噪和声音分离都需要找到多重声音在频域的对应频率分量，并在时域上进行抑制或提取处理。由于音频在时间上呈现出连续性，因此音频中多重声音的频率分量和幅值在时域上可能存在较大变化。在这种情况下，将音频中某一时段进行频域分析获得的不同声音的频率分量作为处理基准并对整段音频应用此配置，则算法正常工作的可能性不大。

为解决该问题，可以将音频在时域上分为多个处理段，每段音频处理段应用对应的频率抑制和提取配置，这意味着在流式处理时需要准确识别出音频的起始帧，并在接下来的时间按顺序执行每一时间段的处理配置。然而，对于 FPGA 处理而言，音频来临的时间是未知的，在音频来临之前只有噪声，如果将某一噪声样本识别为音频的起始帧并加以处理，则会引发处理错误。

环境噪声一般幅值是比较平均的，并且幅值应当远小于测试音频，基于此，可以设置幅度阈值来作为噪声或测试音频来临的判定标准。然而，仅仅使用一个固定的幅度阈值作为判定标准在输出音量可变时则会变得不太可用，因为当输出音量设置为较大值时噪声和测试音频的幅值都会呈现出更高的幅值（相比于输出音量较小时）。此时，可以使用一些基于统计学概念的方法，例如：统计在某一段时间内，音频幅值穿过参考电平的次数与总序列值的比值。由于环境噪声的幅值在任意时间段内穿过参考电平的值应该是较为平均的，而测试音频应该与环境噪声的值有一个明显的差异，因此通过测算一个能明显区分测试音频与环境噪声的穿过参考电平的次数阈值并在 FPGA 中应用，是有效的。

## 声纹识别